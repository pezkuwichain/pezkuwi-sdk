# Prometheus Configuration for PezkuwiChain
# Version: 1.0
# Last Updated: 2025-11-13

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'pezkuwi-mainnet'
    environment: 'production'

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - 'alertmanager:9093'

# Load rules once and periodically evaluate them
rule_files:
  - '/etc/prometheus/rules/*.yml'

# Scrape configurations
scrape_configs:
  # PezkuwiChain node metrics
  - job_name: 'pezkuwi-node'
    static_configs:
      - targets:
          - 'localhost:9615'  # Substrate Prometheus endpoint
        labels:
          node_type: 'validator'
          node_name: 'validator-01'

      - targets:
          - 'validator-02:9615'
        labels:
          node_type: 'validator'
          node_name: 'validator-02'

      - targets:
          - 'validator-03:9615'
        labels:
          node_type: 'validator'
          node_name: 'validator-03'

      - targets:
          - 'rpc-01:9615'
        labels:
          node_type: 'rpc'
          node_name: 'rpc-01'

      - targets:
          - 'archive-01:9615'
        labels:
          node_type: 'archive'
          node_name: 'archive-01'

    # Relabel to add instance name
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
      - source_labels: [node_name]
        target_label: node

  # Node exporter for system metrics
  - job_name: 'node-exporter'
    static_configs:
      - targets:
          - 'localhost:9100'
          - 'validator-02:9100'
          - 'validator-03:9100'
          - 'rpc-01:9100'
          - 'archive-01:9100'
    relabel_configs:
      - source_labels: [__address__]
        regex: '([^:]+):.*'
        target_label: hostname

  # Process exporter for pezkuwi process
  - job_name: 'process-exporter'
    static_configs:
      - targets:
          - 'localhost:9256'
          - 'validator-02:9256'
          - 'validator-03:9256'
          - 'rpc-01:9256'
          - 'archive-01:9256'

  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets:
          - 'localhost:9090'

  # Grafana monitoring
  - job_name: 'grafana'
    static_configs:
      - targets:
          - 'grafana:3000'

  # Loki log aggregation
  - job_name: 'loki'
    static_configs:
      - targets:
          - 'loki:3100'

  # Database metrics (PostgreSQL for indexer)
  - job_name: 'postgres'
    static_configs:
      - targets:
          - 'postgres-exporter:9187'

# Storage configuration
storage:
  tsdb:
    path: /prometheus
    retention:
      time: 30d
      size: 100GB

# Remote write for long-term storage (optional)
# remote_write:
#   - url: 'https://prometheus-remote-storage.example.com/api/v1/write'
#     basic_auth:
#       username: 'pezkuwi'
#       password_file: '/etc/prometheus/remote_storage_password'
